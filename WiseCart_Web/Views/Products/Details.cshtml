@model WiseCart_Web.Models.Product

@{
    ViewData["Title"] = "Detay - " + Model.Name;
    // Resim URL kontrolÃ¼ (BoÅŸsa placeholder kullan)
    var imgUrl = !string.IsNullOrWhiteSpace(Model.ImageUrl) ? Model.ImageUrl : "https://via.placeholder.com/500x500?text=Resim+Yok";
}

<div class="container mt-5 mb-5">
    <div class="card shadow-lg border-0 overflow-hidden">
        <div class="row g-0">
            <div class="col-md-5 bg-white d-flex align-items-center justify-content-center p-4 position-relative">
                <img src="@imgUrl" 
                     class="img-fluid rounded" 
                     alt="@Model.Name" 
                     style="max-height: 450px; object-fit: contain;"
                     onerror="this.onerror=null;this.src='https://via.placeholder.com/500x500?text=Resim+Bulunamadi';">
                
                <span class="position-absolute top-0 start-0 m-3 badge bg-dark fs-6 opacity-75">ID: @Model.Id</span>
            </div>
            
            <div class="col-md-7 bg-light">
                <div class="card-body p-5">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-4">
                            <li class="breadcrumb-item"><a asp-controller="Products" asp-action="Index" class="text-decoration-none">ÃœrÃ¼nler</a></li>
                            <li class="breadcrumb-item active" aria-current="page">@Model.Brand?.Name</li>
                        </ol>
                    </nav>

                    <h3 class="fw-bold text-dark mb-3">@Model.Name</h3>
                    
                    <div class="d-flex flex-wrap gap-2 mb-4">
                        <span class="badge bg-primary bg-opacity-10 text-primary border border-primary px-3 py-2">
                            <i class="fa-solid fa-layer-group"></i> @Model.Category?.Name
                        </span>
                        <span class="badge bg-info bg-opacity-10 text-info border border-info px-3 py-2">
                            <i class="fa-solid fa-tag"></i> @Model.Brand?.Name
                        </span>
                        <span class="badge bg-warning bg-opacity-10 text-warning border border-warning px-3 py-2">
                            <i class="fa-solid fa-star"></i> @Model.ReviewCount Yorum
                        </span>
                    </div>

                    <div class="mb-4">
                        <p class="text-muted mb-0 small text-uppercase fw-bold">GÃ¼ncel SatÄ±ÅŸ FiyatÄ±</p>
                        <h1 class="display-4 text-success fw-bold">
                            @Model.CurrentPrice?.ToString("N0") <small class="fs-4 text-muted">TL</small>
                        </h1>
                    </div>

                    <div class="d-grid gap-3">
                        <a href="@Model.Url" target="_blank" class="btn btn-outline-dark btn-lg rounded-pill">
                            <i class="fa-solid fa-up-right-from-square"></i> SatÄ±cÄ±ya Git (N11)
                        </a>
                        
                        <button id="btnAnaliz" onclick="analyzePrice()" class="btn btn-primary btn-lg text-white rounded-pill shadow-sm hover-scale">
                            <i class="fa-solid fa-robot"></i> Yapay Zeka ile Fiyat Analizi Yap
                        </button>
                    </div>

                    <div id="aiResultArea" class="mt-4" style="display:none;">
                        <div class="card border-0 rounded-3 shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title fw-bold" id="aiTitle">ðŸ”„ Analiz Ediliyor...</h5>
                                <p class="card-text mb-2 text-muted" id="aiMessage">Veriler Python Yapay Zeka motoruna gÃ¶nderiliyor...</p>
                                
                                <div class="progress mt-2" id="aiLoading" style="height: 6px;">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                                </div>

                                <div id="recommendations" class="mt-4 pt-3 border-top" style="display:none;">
                                    <h6 class="fw-bold text-success mb-3">
                                        <i class="fa-solid fa-lightbulb"></i> Sizin Ä°Ã§in Daha Uygun Alternatifler:
                                    </h6>
                                    <div class="list-group list-group-flush rounded-3" id="recList">
                                        </div>
                                </div>

                            </div>
                        </div>
                    </div>
                    </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Sayfa yÃ¼klendiÄŸinde Ã§alÄ±ÅŸacak
        document.addEventListener("DOMContentLoaded", function() {
            // Buton ve SonuÃ§ KutularÄ±nÄ± SeÃ§
            const analyzeBtn = document.getElementById("analyzeBtn");
            const loadingDiv = document.getElementById("ai-loading");
            const resultDiv = document.getElementById("ai-result");
            
            // FiyatÄ± C#'dan al, temizle (TL ve noktalarÄ± kaldÄ±r)
            let rawPrice = "@Model.CurrentPrice".replace("TL", "").replace(/\./g, "").replace(",", ".");
            
            // Analiz Butonuna TÄ±klanÄ±nca
            analyzeBtn.addEventListener("click", function() {
                // 1. YÃ¼kleniyor animasyonunu gÃ¶ster
                loadingDiv.classList.remove("d-none");
                resultDiv.classList.add("d-none");
                analyzeBtn.disabled = true;
                analyzeBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Analiz YapÄ±lÄ±yor...';

                // 2. API'ye GÃ¶nderilecek Veri Paketi
                const productData = {
                    Marka: "@Html.Raw(Model.Brand?.Name ?? "")",
                    Kategori: "@Html.Raw(Model.Category?.Name ?? "")",
                    Model: "@Html.Raw(Model.Name ?? "")", // YENÄ°: ÃœrÃ¼n ismini ekledik!
                    Fiyat: parseFloat(rawPrice)
                };

                console.log("API'ye giden veri:", productData); // TarayÄ±cÄ± konsolundan kontrol edebilirsiniz

                // 3. Python API'ye Ä°stek At (Port 5000)
                fetch('http://localhost:5000/predict', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(productData)
                })
                .then(response => response.json())
                .then(data => {
                    // 4. SonuÃ§larÄ± Ekrana Bas
                    document.getElementById("ai-tahmin").innerText = data.tahmin + " TL";
                    document.getElementById("ai-mesaj").innerText = data.mesaj;
                    
                    const durumBadge = document.getElementById("ai-durum");
                    durumBadge.innerText = data.durum;
                    
                    // Renk AyarÄ±
                    durumBadge.className = "badge rounded-pill fs-6 px-3 py-2"; // SÄ±fÄ±rla
                    if (data.durum.includes("PahalÄ±")) durumBadge.classList.add("bg-danger");
                    else if (data.durum.includes("Ucuz")) durumBadge.classList.add("bg-success");
                    else durumBadge.classList.add("bg-warning", "text-dark");

                    // Ã–neriler (Varsa)
                    const suggestionsList = document.getElementById("ai-suggestions");
                    suggestionsList.innerHTML = ""; // Temizle
                    
                    if (data.oneriler && data.oneriler.length > 0) {
                        data.oneriler.forEach(item => {
                            const li = document.createElement("li");
                            li.className = "list-group-item d-flex justify-content-between align-items-center";
                            li.innerHTML = `
                                <div class="d-flex align-items-center">
                                    <img src="${item.resim}" style="width:40px; height:40px; object-fit:contain" class="me-2 border rounded">
                                    <a href="${item.link}" target="_blank" class="text-decoration-none text-dark fw-bold small">${item.ad.substring(0, 30)}...</a>
                                </div>
                                <span class="badge bg-primary rounded-pill">${item.fiyat} TL</span>
                            `;
                            suggestionsList.appendChild(li);
                        });
                        document.getElementById("suggestions-box").classList.remove("d-none");
                    } else {
                        document.getElementById("suggestions-box").classList.add("d-none");
                    }

                    // GÃ¶rÃ¼nÃ¼r Yap
                    loadingDiv.classList.add("d-none");
                    resultDiv.classList.remove("d-none");
                })
                .catch(error => {
                    alert("Yapay Zeka BaÄŸlantÄ± HatasÄ±! api_server.py Ã§alÄ±ÅŸÄ±yor mu?");
                    console.error('Hata:', error);
                })
                .finally(() => {
                    analyzeBtn.disabled = false;
                    analyzeBtn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> Fiyat Analizi Yap';
                });
            });
        });
    </script>
}
<style>
    .hover-scale:hover { transform: scale(1.05); transition: 0.2s; }
</style>