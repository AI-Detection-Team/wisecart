@model WiseCart_Web.Models.Product

@{
    ViewData["Title"] = "Detay - " + Model.Name;
}

<div class="container mt-5 mb-5">
    <div class="card shadow-lg border-0 overflow-hidden">
        <div class="row g-0">
            <div class="col-md-5 bg-light d-flex align-items-center justify-content-center p-4 position-relative">
                <img src="@(string.IsNullOrEmpty(Model.ImageUrl) ? "https://via.placeholder.com/500x500?text=Resim+Yok" : Model.ImageUrl)" 
                     class="img-fluid rounded shadow-sm" alt="@Model.Name" 
                     style="max-height: 450px; object-fit: contain; mix-blend-mode: multiply;">
                
                <span class="position-absolute top-0 start-0 m-3 badge bg-dark fs-6">ID: @Model.Id</span>
            </div>
            
            <div class="col-md-7">
                <div class="card-body p-5">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-4">
                            <li class="breadcrumb-item"><a asp-controller="Products" asp-action="Index" class="text-decoration-none">ÃœrÃ¼nler</a></li>
                            <li class="breadcrumb-item active" aria-current="page">@Model.Brand?.Name</li>
                        </ol>
                    </nav>

                    <h2 class="fw-bold text-dark mb-3">@Model.Name</h2>
                    
                    <div class="d-flex flex-wrap gap-2 mb-4">
                        <span class="badge bg-primary bg-opacity-10 text-primary border border-primary px-3 py-2">
                            <i class="fa-solid fa-layer-group"></i> @Model.Category?.Name
                        </span>
                        <span class="badge bg-info bg-opacity-10 text-info border border-info px-3 py-2">
                            <i class="fa-solid fa-tag"></i> @Model.Brand?.Name
                        </span>
                        <span class="badge bg-warning bg-opacity-10 text-warning border border-warning px-3 py-2">
                            <i class="fa-solid fa-star"></i> @Model.ReviewCount Yorum
                        </span>
                    </div>

                    <div class="mb-4">
                        <p class="text-muted mb-0 small">GÃ¼ncel SatÄ±ÅŸ FiyatÄ±</p>
                        <h1 class="display-5 text-success fw-bold">
                            @Model.CurrentPrice?.ToString("N0") <small class="fs-4 text-muted">TL</small>
                        </h1>
                    </div>

                    <div class="d-grid gap-3">
                        <a href="@Model.Url" target="_blank" class="btn btn-outline-dark btn-lg rounded-pill">
                            <i class="fa-solid fa-up-right-from-square"></i> SatÄ±cÄ±ya Git (N11/HB)
                        </a>
                        
                        <button id="btnAnaliz" onclick="analyzePrice()" class="btn btn-primary btn-lg text-white rounded-pill shadow-sm hover-scale">
                            <i class="fa-solid fa-robot"></i> Yapay Zeka ile Fiyat Analizi Yap
                        </button>
                    </div>

                    <div id="aiResultArea" class="mt-4" style="display:none;">
                        <div class="card bg-light border-0 rounded-3">
                            <div class="card-body">
                                <h5 class="card-title fw-bold" id="aiTitle">ğŸ”„ Analiz Ediliyor...</h5>
                                <p class="card-text mb-2" id="aiMessage">Veriler Python Yapay Zeka motoruna gÃ¶nderiliyor, lÃ¼tfen bekleyin.</p>
                                
                                <div class="progress mt-2" id="aiLoading" style="height: 5px;">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                                </div>

                                <div id="recommendations" class="mt-4 pt-3 border-top" style="display:none;">
                                    <h6 class="fw-bold text-success mb-3">
                                        <i class="fa-solid fa-lightbulb"></i> Sizin Ä°Ã§in Daha Uygun Alternatifler:
                                    </h6>
                                    <div class="list-group list-group-flush rounded-3" id="recList">
                                        </div>
                                </div>

                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<script>
    async function analyzePrice() {
        const btn = document.getElementById("btnAnaliz");
        const area = document.getElementById("aiResultArea");
        const title = document.getElementById("aiTitle");
        const msg = document.getElementById("aiMessage");
        const loading = document.getElementById("aiLoading");
        const recArea = document.getElementById("recommendations");
        const recList = document.getElementById("recList");

        // UI HazÄ±rlÄ±ÄŸÄ±
        btn.disabled = true;
        area.style.display = "block";
        loading.style.display = "flex";
        recArea.style.display = "none";
        recList.innerHTML = ""; // Listeyi temizle
        title.innerText = "ğŸ”„ Analiz Ediliyor...";
        title.className = "card-title text-primary fw-bold";
        msg.innerText = "Yapay Zeka (ML) modeli fiyatÄ± piyasa verileriyle kÄ±yaslÄ±yor...";

        // ÃœrÃ¼n Verisi
        const productData = {
            Marka: "@Model.Brand?.Name",
            Kategori: "@Model.Category?.Name",
            Fiyat: @Model.CurrentPrice
        };

        try {
            // Python API'ye Ä°stek At (Localhost:5000)
            const response = await fetch("http://localhost:5000/predict", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(productData)
            });

            if (!response.ok) throw new Error("API HatasÄ±");

            const result = await response.json();

            // YÃ¼klemeyi gizle
            loading.style.display = "none";
            
            // SONUCU GÃ–STER
            if (result.durum.includes("Ucuz")) {
                title.innerText = "âœ… " + result.durum;
                title.className = "card-title text-success fw-bold";
                msg.innerHTML = `<strong>FÄ±rsat ÃœrÃ¼nÃ¼!</strong><br>AI Tahmini: <strong>${result.tahmin} TL</strong><br>Bu Ã¼rÃ¼n piyasa deÄŸerinin altÄ±nda.`;
            } else if (result.durum.includes("PahalÄ±")) {
                title.innerText = "ğŸ”´ " + result.durum;
                title.className = "card-title text-danger fw-bold";
                msg.innerHTML = `<strong>Dikkat!</strong><br>AI Tahmini: <strong>${result.tahmin} TL</strong><br>Bu Ã¼rÃ¼n olmasÄ± gerekenden pahalÄ± gÃ¶rÃ¼nÃ¼yor.`;
            } else {
                title.innerText = "ğŸŸ¡ " + result.durum;
                title.className = "card-title text-warning fw-bold";
                msg.innerHTML = `<strong>Normal Fiyat.</strong><br>AI Tahmini: <strong>${result.tahmin} TL</strong><br>Fiyat piyasa ortalamasÄ±nda.`;
            }

            // Ã–NERÄ°LER VARSA GÃ–STER
            if (result.oneriler && result.oneriler.length > 0) {
                recArea.style.display = "block";
                result.oneriler.forEach(item => {
                    const html = `
                        <a href="${item.link}" target="_blank" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center p-3">
                            <div class="d-flex align-items-center">
                                <img src="${item.resim}" class="rounded border" style="width:50px; height:50px; object-fit:contain; margin-right:15px; background:white;">
                                <div>
                                    <h6 class="mb-0 fw-bold text-dark">${item.ad}</h6>
                                    <small class="text-muted">Alternatif SeÃ§enek</small>
                                </div>
                            </div>
                            <span class="badge bg-success rounded-pill fs-6">${item.fiyat} TL</span>
                        </a>
                    `;
                    recList.innerHTML += html;
                });
            }

        } catch (error) {
            loading.style.display = "none";
            title.innerText = "âŒ BaÄŸlantÄ± HatasÄ±";
            title.className = "card-title text-danger";
            msg.innerText = "Python servisine ulaÅŸÄ±lamadÄ±. LÃ¼tfen 'api_server.py' kodunun Ã§alÄ±ÅŸtÄ±ÄŸÄ±ndan emin olun.";
            console.error(error);
        } finally {
            btn.disabled = false;
        }
    }
</script>

<style>
    .hover-scale:hover { transform: scale(1.02); transition: 0.2s; }
</style>