@model WiseCart_Web.Models.Product

@{
    ViewData["Title"] = "Detay - " + Model.Name;
}

<div class="container mt-5">
    <div class="card shadow-lg border-0 overflow-hidden">
        <div class="row g-0">
            <div class="col-md-5 bg-light d-flex align-items-center justify-content-center p-5">
                <img src="https://via.placeholder.com/500x500?text=@(Model.Category?.Name)" 
                     class="img-fluid rounded" alt="@Model.Name">
            </div>
            
            <div class="col-md-7">
                <div class="card-body p-5">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a asp-action="Index">ÃœrÃ¼nler</a></li>
                            <li class="breadcrumb-item active" aria-current="page">@Model.Brand?.Name</li>
                        </ol>
                    </nav>

                    <h2 class="fw-bold mb-3">@Model.Name</h2>
                    
                    <div class="d-flex gap-2 mb-4">
                        <span class="badge bg-primary px-3 py-2">@Model.Category?.Name</span>
                        <span class="badge bg-dark px-3 py-2">Model: @Model.Model</span>
                        <span class="badge bg-warning text-dark px-3 py-2">â­ @Model.ReviewCount Yorum</span>
                    </div>

                    <h1 class="display-4 text-success fw-bold mb-4">
                        @Model.CurrentPrice?.ToString("N0") <small class="fs-4 text-muted">TL</small>
                    </h1>

                    <div class="d-grid gap-3">
                        <a href="@Model.Url" target="_blank" class="btn btn-outline-dark btn-lg">
                            ğŸŒ SatÄ±cÄ±ya Git (N11/HB)
                        </a>
                        
                        <button id="btnAnaliz" onclick="analyzePrice()" class="btn btn-primary btn-lg text-white shadow-sm">
                            ğŸ¤– Yapay Zeka ile Fiyat Analizi Yap
                        </button>
                    </div>

                    <div id="aiResultArea" class="mt-4" style="display:none;">
                        <div class="card bg-light border-0">
                            <div class="card-body">
                                <h5 class="card-title" id="aiTitle">ğŸ”„ Analiz Ediliyor...</h5>
                                <p class="card-text" id="aiMessage">Veriler Python Yapay Zeka motoruna gÃ¶nderiliyor, lÃ¼tfen bekleyin.</p>
                                <div class="progress mt-2" id="aiLoading">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<script>
    async function analyzePrice() {
        const btn = document.getElementById("btnAnaliz");
        const area = document.getElementById("aiResultArea");
        const title = document.getElementById("aiTitle");
        const msg = document.getElementById("aiMessage");
        const loading = document.getElementById("aiLoading");

        // UI GÃ¼ncelle
        btn.disabled = true;
        area.style.display = "block";
        title.innerText = "ğŸ”„ Analiz Ediliyor...";
        title.className = "card-title text-primary";
        
        // ÃœrÃ¼n Verisi
        const productData = {
            Marka: "@Model.Brand?.Name",
            Kategori: "@Model.Category?.Name",
            Fiyat: @Model.CurrentPrice
        };

        try {
            // Python API'ye Ä°stek At (Localhost:5000)
            const response = await fetch("http://localhost:5000/predict", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(productData)
            });

            if (!response.ok) throw new Error("API HatasÄ±");

            const result = await response.json();

            // Sonucu GÃ¶ster
            loading.style.display = "none";
            
            if (result.durum.includes("Ucuz")) {
                title.innerText = "âœ… " + result.durum;
                title.className = "card-title text-success fw-bold";
                msg.innerHTML = `<strong>Harika FÄ±rsat!</strong><br>AI Tahmini: <strong>${result.tahmin} TL</strong><br>${result.mesaj}`;
            } else if (result.durum.includes("PahalÄ±")) {
                title.innerText = "ğŸ”´ " + result.durum;
                title.className = "card-title text-danger fw-bold";
                msg.innerHTML = `<strong>Dikkat!</strong><br>AI Tahmini: <strong>${result.tahmin} TL</strong><br>Bu Ã¼rÃ¼n piyasa deÄŸerinin Ã¼zerinde gÃ¶rÃ¼nÃ¼yor.`;
            } else {
                title.innerText = "ğŸŸ¡ " + result.durum;
                title.className = "card-title text-warning fw-bold";
                msg.innerHTML = `<strong>Normal Fiyat.</strong><br>AI Tahmini: <strong>${result.tahmin} TL</strong><br>Fiyat piyasa ortalamasÄ±nda.`;
            }

        } catch (error) {
            loading.style.display = "none";
            title.innerText = "âŒ BaÄŸlantÄ± HatasÄ±";
            title.className = "card-title text-danger";
            msg.innerText = "Python Yapay Zeka servisine ulaÅŸÄ±lamadÄ±. PÄ±nar'Ä±n servisi (api_server.py) aÃ§Ä±k mÄ±?";
        } finally {
            btn.disabled = false;
        }
    }
</script>