@model WiseCart_Web.Models.Product

@{
    ViewData["Title"] = "Detay - " + Model.Name;
    // Resim URL kontrolÃ¼ (BoÅŸsa placeholder kullan)
    var imgUrl = !string.IsNullOrWhiteSpace(Model.ImageUrl) ? Model.ImageUrl : "https://via.placeholder.com/500x500?text=Resim+Yok";
}

<div class="container mt-5 mb-5">
    <div class="card shadow-lg border-0 overflow-hidden">
        <div class="row g-0">
            <div class="col-md-5 bg-white d-flex align-items-center justify-content-center p-4 position-relative">
                <img src="@imgUrl" 
                     class="img-fluid rounded" 
                     alt="@Model.Name" 
                     style="max-height: 450px; object-fit: contain;"
                     onerror="this.onerror=null;this.src='https://via.placeholder.com/500x500?text=Resim+Bulunamadi';">
                
                <span class="position-absolute top-0 start-0 m-3 badge bg-dark fs-6 opacity-75">ID: @Model.Id</span>
            </div>
            
            <div class="col-md-7 bg-light">
                <div class="card-body p-5">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-4">
                            <li class="breadcrumb-item"><a asp-controller="Products" asp-action="Index" class="text-decoration-none">ÃœrÃ¼nler</a></li>
                            <li class="breadcrumb-item active" aria-current="page">@Model.Brand?.Name</li>
                        </ol>
                    </nav>

                    <h3 class="fw-bold text-dark mb-3">@Model.Name</h3>
                    
                    <div class="d-flex flex-wrap gap-2 mb-4">
                        <span class="badge bg-primary bg-opacity-10 text-primary border border-primary px-3 py-2">
                            <i class="fa-solid fa-layer-group"></i> @Model.Category?.Name
                        </span>
                        <span class="badge bg-info bg-opacity-10 text-info border border-info px-3 py-2">
                            <i class="fa-solid fa-tag"></i> @Model.Brand?.Name
                        </span>
                        <span class="badge bg-warning bg-opacity-10 text-warning border border-warning px-3 py-2">
                            <i class="fa-solid fa-star"></i> @Model.ReviewCount Yorum
                        </span>
                    </div>

                    <div class="mb-4">
                        <p class="text-muted mb-0 small text-uppercase fw-bold">GÃ¼ncel SatÄ±ÅŸ FiyatÄ±</p>
                        <h1 class="display-4 text-success fw-bold">
                            @Model.CurrentPrice?.ToString("N0") <small class="fs-4 text-muted">TL</small>
                        </h1>
                    </div>

                    <div class="d-grid gap-3">
                        <a href="@Model.Url" target="_blank" class="btn btn-outline-dark btn-lg rounded-pill">
                            <i class="fa-solid fa-up-right-from-square"></i> SatÄ±cÄ±ya Git (N11)
                        </a>
                        
                        <button id="btnAnaliz" onclick="analyzePrice()" class="btn btn-primary btn-lg text-white rounded-pill shadow-sm hover-scale">
                            <i class="fa-solid fa-robot"></i> Yapay Zeka ile Fiyat Analizi Yap
                        </button>
                    </div>

                    <div id="aiResultArea" class="mt-4" style="display:none;">
                        <div class="card border-0 rounded-3 shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title fw-bold" id="aiTitle">ğŸ”„ Analiz Ediliyor...</h5>
                                <p class="card-text mb-2 text-muted" id="aiMessage">Veriler Python Yapay Zeka motoruna gÃ¶nderiliyor...</p>
                                
                                <div class="progress mt-2" id="aiLoading" style="height: 6px;">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                                </div>

                                <div id="recommendations" class="mt-4 pt-3 border-top" style="display:none;">
                                    <h6 class="fw-bold text-success mb-3">
                                        <i class="fa-solid fa-lightbulb"></i> Sizin Ä°Ã§in Daha Uygun Alternatifler:
                                    </h6>
                                    <div class="list-group list-group-flush rounded-3" id="recList">
                                        </div>
                                </div>

                            </div>
                        </div>
                    </div>
                    </div>
            </div>
        </div>
    </div>
</div>

<script>
    async function analyzePrice() {
        const btn = document.getElementById("btnAnaliz");
        const area = document.getElementById("aiResultArea");
        const title = document.getElementById("aiTitle");
        const msg = document.getElementById("aiMessage");
        const loading = document.getElementById("aiLoading");
        const recArea = document.getElementById("recommendations");
        const recList = document.getElementById("recList");

        // 1. UI HazÄ±rlÄ±ÄŸÄ±
        btn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Analiz YapÄ±lÄ±yor...';
        area.style.display = "block";
        loading.style.display = "flex";
        recArea.style.display = "none";
        recList.innerHTML = ""; 
        
        title.innerText = "ğŸ”„ Analiz Ediliyor...";
        title.className = "card-title text-primary fw-bold";
        msg.innerText = "Yapay Zeka (ML) modeli fiyatÄ± piyasa verileriyle kÄ±yaslÄ±yor...";

        // 2. Veri HazÄ±rlÄ±ÄŸÄ±
        // FiyatÄ± string formatÄ±ndan sayÄ±ya Ã§eviriyoruz (Nokta virgÃ¼l sorunu olmasÄ±n)
        const rawPrice = @(Model.CurrentPrice?.ToString("0.00", System.Globalization.CultureInfo.InvariantCulture) ?? "0");
        
        const productData = {
            Marka: "@Html.Raw(Model.Brand?.Name)",
            Kategori: "@Html.Raw(Model.Category?.Name)",
            Fiyat: rawPrice
        };

        try {
            // 3. API Ä°steÄŸi
            const response = await fetch("http://localhost:5000/predict", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(productData)
            });

            if (!response.ok) throw new Error("API HatasÄ±");

            const result = await response.json();

            // 4. SonuÃ§ GÃ¶sterimi
            loading.style.display = "none";
            btn.innerHTML = '<i class="fa-solid fa-check"></i> Analiz TamamlandÄ±';
            
            // Renk ve Mesaj AyarÄ±
            if (result.durum.includes("Ucuz")) {
                title.innerText = "âœ… " + result.durum;
                title.className = "card-title text-success fw-bold";
            } else if (result.durum.includes("PahalÄ±")) {
                title.innerText = "ğŸ”´ " + result.durum;
                title.className = "card-title text-danger fw-bold";
            } else {
                title.innerText = "ğŸŸ¡ " + result.durum;
                title.className = "card-title text-warning fw-bold";
            }
            
            msg.innerHTML = `<strong>${result.durum}</strong><br>Adil DeÄŸer Tahmini: <strong>${result.tahmin} TL</strong><br>${result.mesaj}`;

            // 5. Ã–NERÄ°LERÄ° LÄ°STELEME (RESÄ°M HATASI DÃœZELTÄ°LDÄ°)
            if (result.oneriler && result.oneriler.length > 0) {
                recArea.style.display = "block";
                result.oneriler.forEach(item => {
                    // Resim URL kontrolÃ¼
                    let imgSrc = item.resim;
                    if (!imgSrc || imgSrc === "nan") imgSrc = "https://via.placeholder.com/150?text=Resim+Yok";

                    const html = `
                        <a href="${item.link}" target="_blank" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center p-3 border-bottom">
                            <div class="d-flex align-items-center">
                                <img src="${imgSrc}" class="rounded border p-1 bg-white" 
                                     style="width:60px; height:60px; object-fit:contain; margin-right:15px;"
                                     onerror="this.src='https://via.placeholder.com/150?text=Hata'">
                                <div>
                                    <h6 class="mb-0 fw-bold text-dark text-truncate" style="max-width: 300px;">${item.ad}</h6>
                                    <small class="text-muted">Alternatif SeÃ§enek</small>
                                </div>
                            </div>
                            <span class="badge bg-success rounded-pill fs-6">${item.fiyat} TL</span>
                        </a>
                    `;
                    recList.innerHTML += html;
                });
            }

        } catch (error) {
            loading.style.display = "none";
            title.innerText = "âŒ BaÄŸlantÄ± HatasÄ±";
            title.className = "card-title text-danger";
            msg.innerText = "Python servisine ulaÅŸÄ±lamadÄ±. 'api_server.py' Ã§alÄ±ÅŸÄ±yor mu?";
            btn.innerHTML = '<i class="fa-solid fa-rotate-right"></i> Tekrar Dene';
            btn.disabled = false;
            console.error(error);
        }
    }
</script>
<style>
    .hover-scale:hover { transform: scale(1.05); transition: 0.2s; }
</style>