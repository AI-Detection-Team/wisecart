@model WiseCart_Web.Models.Product

@{
    ViewData["Title"] = "Detay - " + Model.Name;
    // Resim URL kontrol√º
    var imgUrl = !string.IsNullOrWhiteSpace(Model.ImageUrl) ? Model.ImageUrl : "https://via.placeholder.com/500x500?text=Resim+Yok";
}

<div class="container mt-5 mb-5">
    <div class="card shadow-lg border-0 overflow-hidden">
        <div class="row g-0">
            <div class="col-md-5 bg-white d-flex align-items-center justify-content-center p-4 position-relative">
                <img src="@imgUrl" 
                     class="img-fluid rounded" 
                     alt="@Model.Name" 
                     style="max-height: 450px; object-fit: contain;"
                     onerror="this.onerror=null;this.src='https://via.placeholder.com/500x500?text=Resim+Bulunamadi';">
                
                <span class="position-absolute top-0 start-0 m-3 badge bg-dark fs-6 opacity-75">ID: @Model.Id</span>
            </div>
            
            <div class="col-md-7 bg-light">
                <div class="card-body p-5">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-4">
                            <li class="breadcrumb-item"><a asp-controller="Products" asp-action="Index" class="text-decoration-none">√úr√ºnler</a></li>
                            <li class="breadcrumb-item active" aria-current="page">@Model.Brand?.Name</li>
                        </ol>
                    </nav>

                    <h3 class="fw-bold text-dark mb-3">@Model.Name</h3>
                    
                    <div class="d-flex flex-wrap gap-2 mb-4">
                        <span class="badge bg-primary bg-opacity-10 text-primary border border-primary px-3 py-2">
                            <i class="fa-solid fa-layer-group"></i> @Model.Category?.Name
                        </span>
                        <span class="badge bg-info bg-opacity-10 text-info border border-info px-3 py-2">
                            <i class="fa-solid fa-tag"></i> @Model.Brand?.Name
                        </span>
                        <span class="badge bg-warning bg-opacity-10 text-warning border border-warning px-3 py-2">
                            <i class="fa-solid fa-star"></i> @Model.ReviewCount Yorum
                        </span>
                    </div>

                    <div class="mb-4">
                        <p class="text-muted mb-0 small text-uppercase fw-bold">G√ºncel Satƒ±≈ü Fiyatƒ±</p>
                        <h1 class="display-4 text-success fw-bold">
                            @Model.CurrentPrice?.ToString("N0") <small class="fs-4 text-muted">TL</small>
                        </h1>
                    </div>

                    <div class="d-grid gap-3">
                        <a href="@Model.Url" target="_blank" class="btn btn-outline-dark btn-lg rounded-pill">
                            <i class="fa-solid fa-up-right-from-square"></i> Satƒ±cƒ±ya Git (Link)
                        </a>
                        
                        <button id="analyzeBtn" class="btn btn-primary btn-lg text-white rounded-pill shadow-sm hover-scale">
                            <i class="fa-solid fa-wand-magic-sparkles"></i> Yapay Zeka ile Fiyat Analizi Yap
                        </button>
                    </div>

                    <div id="ai-loading" class="mt-4 d-none">
                         <div class="card border-0 rounded-3 shadow-sm bg-white">
                            <div class="card-body text-center py-4">
                                <div class="spinner-border text-primary" role="status"></div>
                                <p class="mt-2 text-muted fw-bold">Yapay Zeka Fiyatƒ± Analiz Ediyor...</p>
                            </div>
                         </div>
                    </div>

                    <div id="ai-result" class="mt-4 d-none">
                        <div class="card border-0 rounded-3 shadow-sm bg-white">
                            <div class="card-body p-4 text-center">
                                <span id="ai-durum" class="badge bg-warning text-dark fs-6 px-3 py-2">Hesaplanƒ±yor...</span>
                                <h2 class="fw-bold mt-3 text-primary" id="ai-tahmin">0 TL</h2>
                                <p id="ai-mesaj" class="text-muted">Analiz sonucu bekleniyor.</p>
                                
                                <div id="suggestions-box" class="mt-3 d-none text-start">
                                    <hr>
                                    <h6 class="fw-bold text-success small mb-3">
                                        <i class="fa-solid fa-lightbulb"></i> Sizin ƒ∞√ßin Daha Uygun Alternatifler:
                                    </h6>
                                    <ul id="ai-suggestions" class="list-group list-group-flush"></ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // Elementleri Se√ß
            const analyzeBtn = document.getElementById("analyzeBtn");
            const loadingDiv = document.getElementById("ai-loading");
            const resultDiv = document.getElementById("ai-result");

            if (!analyzeBtn) {
                console.error("HATA: Analiz butonu bulunamadƒ±!");
                return;
            }

            // --- KRƒ∞Tƒ∞K D√úZELTME BURADA ---
            // C# verilerini g√ºvenli bir ≈üekilde JSON formatƒ±na √ßeviriyoruz.
            // Bu y√∂ntem tƒ±rnak i≈üaretlerini, enter karakterlerini otomatik d√ºzeltir.
            const modelName = @Json.Serialize(Model.Name ?? "");
            const brandName = @Json.Serialize(Model.Brand?.Name ?? "");
            const categoryName = @Json.Serialize(Model.Category?.Name ?? "");
            
            // Fiyatƒ± g√ºvenli ≈üekilde sayƒ±ya √ßevir (Nokta/Virg√ºl sorununu √ß√∂zer)
            const rawPriceCsharp = "@Model.CurrentPrice"; 
            let priceVal = parseFloat(rawPriceCsharp.replace("TL", "").replace(/\./g, "").replace(",", ".")) || 0;

            console.log("‚úÖ Sayfa Hazƒ±r. √úr√ºn:", modelName);

            analyzeBtn.addEventListener("click", function() {
                console.log("üñ±Ô∏è Butona basƒ±ldƒ±!");

                // G√∂r√ºn√ºm Ayarlarƒ±
                loadingDiv.classList.remove("d-none");
                resultDiv.classList.add("d-none");
                analyzeBtn.disabled = true;
                analyzeBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Hesaplanƒ±yor...';

                // API'ye Gidecek Veri Paketi
                const productData = {
                    Marka: brandName,
                    Kategori: categoryName,
                    Model: modelName,
                    Fiyat: priceVal
                };

                console.log("üì° API ƒ∞steƒüi:", productData);

                // ƒ∞stek At (Port 5000)
                fetch('http://localhost:5000/predict', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(productData)
                })
                .then(res => {
                    if (!res.ok) throw new Error("Sunucu Hatasƒ±: " + res.status);
                    return res.json();
                })
                .then(data => {
                    console.log("üì• Sonu√ß Geldi:", data);

                    // Sonu√ßlarƒ± Bas
                    document.getElementById("ai-tahmin").innerText = data.tahmin + " TL";
                    document.getElementById("ai-mesaj").innerText = data.mesaj;
                    
                    const badge = document.getElementById("ai-durum");
                    badge.innerText = data.durum;
                    
                    // Renkler
                    badge.className = "badge rounded-pill fs-6 px-3 py-2"; 
                    if(data.durum.includes("Pahalƒ±")) badge.classList.add("bg-danger");
                    else if(data.durum.includes("Ucuz")) badge.classList.add("bg-success");
                    else badge.classList.add("bg-warning", "text-dark");

                    // √ñneriler
                    const list = document.getElementById("ai-suggestions");
                    list.innerHTML = "";
                    if (data.oneriler && data.oneriler.length > 0) {
                        data.oneriler.forEach(item => {
                            list.innerHTML += `
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        <img src="${item.resim}" style="width:30px; height:30px; object-fit:contain; margin-right:10px;" onerror="this.src='https://via.placeholder.com/30'">
                                        <a href="${item.link}" target="_blank" class="fw-bold text-dark text-decoration-none small">${item.ad.substring(0,30)}...</a>
                                    </div>
                                    <span class="badge bg-primary">${item.fiyat} TL</span>
                                </li>`;
                        });
                        document.getElementById("suggestions-box").classList.remove("d-none");
                    } else {
                        document.getElementById("suggestions-box").classList.add("d-none");
                    }

                    loadingDiv.classList.add("d-none");
                    resultDiv.classList.remove("d-none");
                })
                .catch(err => {
                    console.error("API Hatasƒ±:", err);
                    alert("HATA: Yapay Zeka servisine baƒülanƒ±lamadƒ±! Pƒ±nar'ƒ±n terminalini (Port 5000) kontrol edin.");
                })
                .finally(() => {
                    analyzeBtn.disabled = false;
                    analyzeBtn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> Yapay Zeka ile Fiyat Analizi Yap';
                });
            });
        });
    </script>
}

<style>
    .hover-scale:hover { transform: scale(1.02); transition: 0.2s; }
</style>