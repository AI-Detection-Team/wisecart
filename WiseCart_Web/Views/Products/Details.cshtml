@model WiseCart_Web.Models.Product

@{
    ViewData["Title"] = "Detay - " + Model.Name;
    // Resim URL kontrol√º
    var imgUrl = !string.IsNullOrWhiteSpace(Model.ImageUrl) ? Model.ImageUrl : "https://via.placeholder.com/500x500?text=Resim+Yok";
}

<div class="container mt-5 mb-5">
    <div class="card shadow-lg border-0 overflow-hidden">
        <div class="row g-0">
            <div class="col-md-5 bg-white d-flex align-items-center justify-content-center p-4 position-relative">
                <img src="@imgUrl" 
                     class="img-fluid rounded" 
                     alt="@Model.Name" 
                     style="max-height: 450px; object-fit: contain;"
                     onerror="this.onerror=null;this.src='https://via.placeholder.com/500x500?text=Resim+Bulunamadi';">
                
                <span class="position-absolute top-0 start-0 m-3 badge bg-dark fs-6 opacity-75">ID: @Model.Id</span>
            </div>
            
            <div class="col-md-7 bg-light">
                <div class="card-body p-5">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-4">
                            <li class="breadcrumb-item"><a asp-controller="Products" asp-action="Index" class="text-decoration-none">√úr√ºnler</a></li>
                            <li class="breadcrumb-item active" aria-current="page">@Model.Brand?.Name</li>
                        </ol>
                    </nav>

                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <h3 class="fw-bold text-dark mb-0">@Model.Name</h3>
                        @if (User.Identity.IsAuthenticated)
                        {
                            <button id="favoriteBtn" class="btn btn-outline-danger border-0" style="font-size: 1.5rem;">
                                <i class="fa-regular fa-heart"></i>
                            </button>
                        }
                    </div>
                    
                    <div class="d-flex flex-wrap gap-2 mb-4">
                        <span class="badge bg-primary bg-opacity-10 text-primary border border-primary px-3 py-2">
                            <i class="fa-solid fa-layer-group"></i> @Model.Category?.Name
                        </span>
                        <span class="badge bg-info bg-opacity-10 text-info border border-info px-3 py-2">
                            <i class="fa-solid fa-tag"></i> @Model.Brand?.Name
                        </span>
                        <span class="badge bg-warning bg-opacity-10 text-warning border border-warning px-3 py-2">
                            <i class="fa-solid fa-star"></i> @Model.ReviewCount Yorum
                        </span>
                    </div>

                    <div class="mb-4">
                        <p class="text-muted mb-0 small text-uppercase fw-bold">G√ºncel Satƒ±≈ü Fiyatƒ±</p>
                        <h1 class="display-4 text-success fw-bold">
                            @Model.CurrentPrice?.ToString("N0") <small class="fs-4 text-muted">TL</small>
                        </h1>
                    </div>

                    <div class="d-grid gap-3">
                        <a href="@Model.Url" target="_blank" class="btn btn-outline-dark btn-lg rounded-pill">
                            <i class="fa-solid fa-up-right-from-square"></i> Satƒ±cƒ±ya Git (Link)
                        </a>
                        
                        <button id="analyzeBtn" class="btn btn-primary btn-lg text-white rounded-pill shadow-sm hover-scale">
                            <i class="fa-solid fa-wand-magic-sparkles"></i> Yapay Zeka ile Fiyat Analizi Yap
                        </button>
                    </div>

                    <div id="ai-loading" class="mt-4 d-none">
                         <div class="card border-0 rounded-3 shadow-sm bg-white">
                            <div class="card-body text-center py-4">
                                <div class="spinner-border text-primary" role="status"></div>
                                <p class="mt-2 text-muted fw-bold">Yapay Zeka Fiyatƒ± Analiz Ediyor...</p>
                            </div>
                         </div>
                    </div>

                    <div id="ai-result" class="mt-4 d-none">
                        <div class="card border-0 rounded-4 shadow-lg overflow-hidden" style="background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);">
                            <div class="card-body p-5">
                                <!-- AI Analiz Sonucu -->
                                <div class="text-center mb-4">
                                    <div id="ai-durum-badge" class="mb-3">
                                        <span id="ai-durum" class="badge rounded-pill fs-6 px-4 py-3 shadow-sm">
                                            <i class="fa-solid fa-circle-check me-2"></i>
                                            <span id="ai-durum-text">Hesaplanƒ±yor...</span>
                                        </span>
                                    </div>
                                    <div class="my-4">
                                        <p class="text-muted small mb-2">Yapay Zeka Tahmini Fiyat</p>
                                        <h2 class="fw-bold display-5 text-primary mb-2" id="ai-tahmin">0 TL</h2>
                                    </div>
                                    <div class="bg-white rounded-3 p-3 shadow-sm">
                                        <p id="ai-mesaj" class="text-muted mb-0 fw-medium">Analiz sonucu bekleniyor.</p>
                                    </div>
                                </div>
                                
                                <!-- Alternatif √úr√ºnler -->
                                <div id="suggestions-box" class="mt-5 d-none">
                                    <hr class="my-4">
                                    <h5 class="fw-bold text-success mb-4">
                                        <i class="fa-solid fa-lightbulb me-2"></i> Sizin ƒ∞√ßin Daha Uygun Alternatifler:
                                    </h5>
                                    <div id="ai-suggestions" class="row g-3"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Fiyat Analizi Grafiƒüi -->
    <div class="container mt-5">
        <div class="card shadow-lg border-0">
            <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <h4 class="mb-0">
                    <i class="fa-solid fa-chart-line"></i> Fiyat Analizi (Son 6 Ay)
                </h4>
            </div>
            <div class="card-body p-4">
                <canvas id="priceChart" style="max-height: 300px;"></canvas>
                <div id="priceRecommendation" class="mt-3 text-center">
                    <p class="fw-bold fs-5 mb-0" id="recommendationText"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Benzer √úr√ºnler -->
    @{
        var similarProducts = ViewBag.SimilarProducts as List<WiseCart_Web.Models.Product> ?? new List<WiseCart_Web.Models.Product>();
    }
    @if (similarProducts.Any())
    {
        <div class="container mt-5 mb-5">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-light">
                    <h4 class="mb-0">
                        <i class="fa-solid fa-star"></i> Sizin ƒ∞√ßin Se√ßtiklerimiz
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        @foreach (var similar in similarProducts)
                        {
                            <div class="col-md-3 col-sm-6">
                                <div class="card border h-100 hover-shadow position-relative">
                                    @if (User.Identity.IsAuthenticated)
                                    {
                                        <button class="favorite-btn position-absolute top-0 end-0 m-2 btn btn-sm border-0 rounded-circle shadow-sm" 
                                                data-product-id="@similar.Id" 
                                                style="background: rgba(255, 255, 255, 0.9); z-index: 10; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center;"
                                                title="Favorilere Ekle"
                                                onclick="event.preventDefault(); event.stopPropagation();">
                                            <i class="fa-regular fa-heart text-danger" style="font-size: 1rem;"></i>
                                        </button>
                                    }
                                    <a asp-controller="Products" asp-action="Details" asp-route-id="@similar.Id" class="text-decoration-none">
                                        <img src="@(similar.ImageUrl ?? "https://via.placeholder.com/200")" 
                                             class="card-img-top" 
                                             style="height: 200px; object-fit: cover;"
                                             alt="@similar.Name"
                                             onerror="this.src='https://via.placeholder.com/200'">
                                        <div class="card-body">
                                            <h6 class="card-title text-dark fw-bold" style="font-size: 0.9rem;">
                                                @(similar.Name?.Length > 50 ? similar.Name.Substring(0, 50) + "..." : similar.Name)
                                            </h6>
                                            <p class="text-success fw-bold mb-2">
                                                @similar.CurrentPrice?.ToString("N0") TL
                                            </p>
                                            <div class="d-flex gap-1">
                                                <span class="badge bg-info bg-opacity-10 text-info" style="font-size: 0.7rem;">
                                                    @similar.Brand?.Name
                                                </span>
                                            </div>
                                        </div>
                                    </a>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<style>
    /* Favorileme Butonlarƒ± i√ßin Stil */
    .favorite-btn {
        transition: all 0.3s ease;
    }
    
    .favorite-btn:hover {
        background: rgba(255, 255, 255, 1) !important;
        transform: scale(1.1);
    }
    
    .favorite-btn.active i {
        font-weight: 900;
    }
    
    .favorite-btn.active .fa-regular {
        display: none;
    }
    
    .favorite-btn.active .fa-solid {
        display: inline-block !important;
    }
    
    .favorite-btn .fa-solid {
        display: none;
    }
</style>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // Elementleri Se√ß
            const analyzeBtn = document.getElementById("analyzeBtn");
            const loadingDiv = document.getElementById("ai-loading");
            const resultDiv = document.getElementById("ai-result");
            const favoriteBtn = document.getElementById("favoriteBtn");

            // --- KRƒ∞Tƒ∞K D√úZELTME BURADA ---
            // C# verilerini g√ºvenli bir ≈üekilde JSON formatƒ±na √ßeviriyoruz.
            // Bu y√∂ntem tƒ±rnak i≈üaretlerini, enter karakterlerini otomatik d√ºzeltir.
            const modelName = @Json.Serialize(Model.Name ?? "");
            const brandName = @Json.Serialize(Model.Brand?.Name ?? "");
            const categoryName = @Json.Serialize(Model.Category?.Name ?? "");
            const productId = @Model.Id;
            
            // Fiyatƒ± g√ºvenli ≈üekilde sayƒ±ya √ßevir (C# double direkt sayƒ± olarak)
            const priceVal = @(Model.CurrentPrice?.ToString("F2", System.Globalization.CultureInfo.InvariantCulture) ?? "0");

            console.log("‚úÖ Sayfa Hazƒ±r. √úr√ºn:", modelName);

            // --- FAVORƒ∞ BUTONU ---
            if (favoriteBtn) {
                // Mevcut favori durumunu kontrol et
                fetch(`/api/Favorites/Check/${productId}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.isFavorite) {
                            favoriteBtn.innerHTML = '<i class="fa-solid fa-heart"></i>';
                            favoriteBtn.classList.add('text-danger');
                        }
                    });

                favoriteBtn.addEventListener('click', function() {
                    fetch('/api/Favorites/Toggle', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(productId)
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.isFavorite) {
                            favoriteBtn.innerHTML = '<i class="fa-solid fa-heart"></i>';
                            favoriteBtn.classList.add('text-danger');
                            if (typeof showToast !== 'undefined') {
                                showToast('success', 'Favorilere Eklendi', 'Bu √ºr√ºn favorilerinize eklendi. Profil sayfanƒ±zdan g√∂r√ºnt√ºleyebilirsiniz.');
                            }
                        } else {
                            favoriteBtn.innerHTML = '<i class="fa-regular fa-heart"></i>';
                            favoriteBtn.classList.remove('text-danger');
                            if (typeof showToast !== 'undefined') {
                                showToast('info', 'Favorilerden √áƒ±karƒ±ldƒ±', 'Bu √ºr√ºn favorilerinizden √ßƒ±karƒ±ldƒ±.');
                            }
                        }
                    })
                    .catch(err => {
                        console.error('Favori hatasƒ±:', err);
                        if (typeof showToast !== 'undefined') {
                            showToast('error', 'ƒ∞≈ülem Ba≈üarƒ±sƒ±z', 'Favori i≈ülemi sƒ±rasƒ±nda bir hata olu≈ütu. L√ºtfen tekrar deneyin.');
                        }
                    });
                });
            }

            // --- BENZER √úR√úNLER ƒ∞√áƒ∞N FAVORƒ∞LEME BUTONLARI ---
            @if (User.Identity.IsAuthenticated)
            {
                <text>
                const similarFavoriteButtons = document.querySelectorAll('.favorite-btn[data-product-id]');
                
                similarFavoriteButtons.forEach(btn => {
                    const similarProductId = parseInt(btn.getAttribute('data-product-id'));
                    
                    // Mevcut favori durumunu kontrol et
                    fetch(`/api/Favorites/Check/${similarProductId}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.isFavorite) {
                                btn.classList.add('active');
                                const icon = btn.querySelector('i');
                                icon.classList.remove('fa-regular');
                                icon.classList.add('fa-solid');
                            }
                        })
                        .catch(error => console.error('Favori kontrol hatasƒ±:', error));
                    
                    // Favori butonuna tƒ±klama
                    btn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const icon = btn.querySelector('i');
                        const isActive = btn.classList.contains('active');
                        
                        // Optimistic UI update
                        if (isActive) {
                            btn.classList.remove('active');
                            icon.classList.remove('fa-solid');
                            icon.classList.add('fa-regular');
                        } else {
                            btn.classList.add('active');
                            icon.classList.remove('fa-regular');
                            icon.classList.add('fa-solid');
                        }
                        
                        // API √ßaƒürƒ±sƒ±
                        fetch('/api/Favorites/Toggle', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(similarProductId)
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.message && typeof showToast === 'function') {
                                showToast(data.isFavorite ? 'success' : 'info', 
                                         data.isFavorite ? 'Favorilere Eklendi' : 'Favorilerden √áƒ±karƒ±ldƒ±', 
                                         data.message);
                            }
                        })
                        .catch(error => {
                            console.error('Favori i≈ülemi hatasƒ±:', error);
                            // Hata durumunda geri al
                            if (isActive) {
                                btn.classList.add('active');
                                icon.classList.remove('fa-regular');
                                icon.classList.add('fa-solid');
                            } else {
                                btn.classList.remove('active');
                                icon.classList.remove('fa-solid');
                                icon.classList.add('fa-regular');
                            }
                        });
                    });
                });
                </text>
            }

            // --- Fƒ∞YAT ANALƒ∞Zƒ∞ GRAFƒ∞ƒûƒ∞ ---
            const ctx = document.getElementById('priceChart');
            if (ctx) {
                // Son 6 ay i√ßin dummy veri olu≈ütur
                const months = [];
                const prices = [];
                const currentPrice = priceVal;
                
                // Son 6 ayƒ±n isimlerini olu≈ütur
                const monthNames = ['Temmuz', 'Aƒüustos', 'Eyl√ºl', 'Ekim', 'Kasƒ±m', 'Aralƒ±k'];
                for (let i = 5; i >= 0; i--) {
                    months.push(monthNames[i]);
                    // Rastgele fiyat deƒüi≈üimi (mevcut fiyatƒ±n %80-120 arasƒ±)
                    const variation = 0.8 + Math.random() * 0.4;
                    prices.push(Math.round(currentPrice * variation));
                }

                // Trend hesapla
                const firstPrice = prices[0];
                const lastPrice = prices[prices.length - 1];
                const trend = lastPrice - firstPrice;
                const trendPercent = ((trend / firstPrice) * 100).toFixed(1);
                
                // √ñneri metni
                let recommendationText = '';
                let recommendationClass = '';
                if (trend < -currentPrice * 0.1) {
                    recommendationText = 'üü¢ ≈ûu an almak i√ßin en iyi zaman! Fiyat d√º≈ü√º≈üte.';
                    recommendationClass = 'text-success';
                } else if (trend > currentPrice * 0.1) {
                    recommendationText = 'üî¥ Fiyat y√ºkseli≈üte. Beklemenizi √∂neririz.';
                    recommendationClass = 'text-danger';
                } else {
                    recommendationText = 'üü° Fiyat stabil. ƒ∞stediƒüiniz zaman alabilirsiniz.';
                    recommendationClass = 'text-warning';
                }
                
                document.getElementById('recommendationText').textContent = recommendationText;
                document.getElementById('recommendationText').className = 'fw-bold fs-5 mb-0 ' + recommendationClass;

                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [{
                            label: 'Fiyat (TL)',
                            data: prices,
                            borderColor: 'rgb(102, 126, 234)',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 5,
                            pointHoverRadius: 7
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return 'Fiyat: ' + context.parsed.y.toLocaleString('tr-TR') + ' TL';
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                ticks: {
                                    callback: function(value) {
                                        return value.toLocaleString('tr-TR') + ' TL';
                                    }
                                }
                            }
                        }
                    }
                });
            }

            if (!analyzeBtn) {
                console.error("HATA: Analiz butonu bulunamadƒ±!");
                return;
            }

            analyzeBtn.addEventListener("click", function() {
                console.log("üñ±Ô∏è Butona basƒ±ldƒ±!");

                // G√∂r√ºn√ºm Ayarlarƒ±
                loadingDiv.classList.remove("d-none");
                resultDiv.classList.add("d-none");
                analyzeBtn.disabled = true;
                analyzeBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Hesaplanƒ±yor...';

                // API'ye Gidecek Veri Paketi
                const productData = {
                    Marka: brandName,
                    Kategori: categoryName,
                    Model: modelName,
                    Fiyat: priceVal
                };

                console.log("üì° API ƒ∞steƒüi:", productData);

                // ƒ∞stek At (Port 5001 - macOS AirPlay port 5000'i kullandƒ±ƒüƒ± i√ßin)
                fetch('http://localhost:5001/predict', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(productData)
                })
                .then(res => {
                    if (!res.ok) throw new Error("Sunucu Hatasƒ±: " + res.status);
                    return res.json();
                })
                .then(data => {
                    console.log("üì• Sonu√ß Geldi:", data);

                    // Sonu√ßlarƒ± Bas
                    document.getElementById("ai-tahmin").innerText = data.tahmin + " TL";
                    document.getElementById("ai-mesaj").innerText = data.mesaj;
                    
                    // Badge ve ƒ∞kon G√ºncellemesi
                    const badge = document.getElementById("ai-durum");
                    const badgeText = document.getElementById("ai-durum-text");
                    const badgeIcon = badge.querySelector('i');
                    
                    badge.className = "badge rounded-pill fs-6 px-4 py-3 shadow-sm";
                    badgeText.innerText = data.durum;
                    
                    // Renk ve ikon ayarlarƒ±
                    if(data.durum.includes("Pahalƒ±")) {
                        badge.classList.add("bg-danger", "text-white");
                        badgeIcon.className = "fa-solid fa-circle-exclamation me-2";
                    } else if(data.durum.includes("Ucuz")) {
                        badge.classList.add("bg-success", "text-white");
                        badgeIcon.className = "fa-solid fa-circle-check me-2";
                    } else {
                        badge.classList.add("bg-warning", "text-dark");
                        badgeIcon.className = "fa-solid fa-circle-info me-2";
                    }

                    // √ñneriler - G√ºzel Card Tasarƒ±mƒ±
                    const suggestionsContainer = document.getElementById("ai-suggestions");
                    suggestionsContainer.innerHTML = "";
                    if (data.oneriler && data.oneriler.length > 0) {
                        data.oneriler.forEach(item => {
                            const col = document.createElement('div');
                            col.className = "col-md-4 col-sm-6";
                            col.innerHTML = `
                                <div class="card h-100 border-0 shadow-sm hover-lift" style="transition: all 0.3s ease;">
                                    <div class="card-body p-3">
                                        <div class="text-center mb-3">
                                            <img src="${item.resim}" 
                                                 class="img-fluid rounded" 
                                                 style="max-height: 120px; width: auto; object-fit: contain;" 
                                                 onerror="this.src='https://via.placeholder.com/150?text=√úr√ºn'"
                                                 alt="${item.ad.substring(0, 50)}">
                                        </div>
                                        <h6 class="card-title fw-bold text-dark mb-2" style="font-size: 0.9rem; min-height: 2.5rem; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                                            ${item.ad.length > 60 ? item.ad.substring(0, 60) + '...' : item.ad}
                                        </h6>
                                        <div class="d-flex justify-content-between align-items-center mt-auto">
                                            <span class="badge bg-primary fs-6 px-3 py-2">${item.fiyat} TL</span>
                                            <a href="${item.link}" target="_blank" class="btn btn-sm btn-outline-primary rounded-pill">
                                                <i class="fa-solid fa-external-link-alt me-1"></i> ƒ∞ncele
                                            </a>
                                        </div>
                                    </div>
                                </div>`;
                            suggestionsContainer.appendChild(col);
                        });
                        document.getElementById("suggestions-box").classList.remove("d-none");
                    } else {
                        document.getElementById("suggestions-box").classList.add("d-none");
                    }

                    loadingDiv.classList.add("d-none");
                    resultDiv.classList.remove("d-none");
                })
                .catch(err => {
                    console.error("API Hatasƒ±:", err);
                    if (typeof showToast !== 'undefined') {
                        showToast(
                            'error',
                            'Yapay Zeka Servisi Hatasƒ±',
                            'Yapay Zeka fiyat analizi ≈üu anda kullanƒ±lamƒ±yor. L√ºtfen daha sonra tekrar deneyin.'
                        );
                    } else {
                        alert("HATA: Yapay Zeka servisine baƒülanƒ±lamadƒ±! L√ºtfen daha sonra tekrar deneyin.");
                    }
                })
                .finally(() => {
                    analyzeBtn.disabled = false;
                    analyzeBtn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> Yapay Zeka ile Fiyat Analizi Yap';
                    loadingDiv.classList.add("d-none");
                });
            });
        });
    </script>
}

<style>
    .hover-scale:hover { transform: scale(1.02); transition: 0.2s; }
    .hover-shadow:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
        transition: box-shadow 0.3s;
        transform: translateY(-2px);
    }
    #favoriteBtn:hover {
        transform: scale(1.1);
        transition: transform 0.2s;
    }
    
    /* AI Analiz Sonu√ßlarƒ± i√ßin √ñzel Stil */
    #ai-result .card {
        border: 2px solid rgba(111, 66, 193, 0.1);
    }
    
    .hover-lift:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15) !important;
    }
    
    #ai-durum-badge .badge {
        font-weight: 600;
        letter-spacing: 0.5px;
    }
    
    #ai-result #ai-tahmin {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    #suggestions-box .card {
        border-radius: 12px;
    }
    
    #suggestions-box .card-title {
        line-height: 1.4;
    }
</style>